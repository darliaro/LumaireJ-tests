name: Run API & E2E Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [run-tests]

permissions:
  contents: read

concurrency:
  group: api-e2e-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:  # Setup job: prepare SUT and test environment
    name: Setup SUT and Test Environment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout tests
        uses: actions/checkout@v4

      - name: Checkout SUT
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/LumaireJ
          path: app

      - name: Cache SUT PDM & venv
        uses: actions/cache@v4
        with:
          key: pdm-app-${{ runner.os }}-${{ hashFiles('app/pdm.lock') }}
          restore-keys: pdm-app-
          path: |
            ~/.cache/pdm
            app/.venv

      - name: Setup PDM for SUT
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install SUT deps
        working-directory: app
        run: pdm install

      - name: Cache test PDM & venv
        uses: actions/cache@v4
        with:
          key: pdm-test-${{ runner.os }}-${{ hashFiles('pdm.lock') }}
          restore-keys: pdm-test-
          path: |
            ~/.cache/pdm
            .venv

      - name: Setup PDM for tests
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install test deps
        run: pdm install -G dev

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          key: playwright-${{ runner.os }}-${{ hashFiles('pdm.lock') }}
          restore-keys: playwright-${{ runner.os }}-
          path: |
            ~/.cache/ms-playwright

      - name: Install Playwright browsers
        working-directory: tests
        run: pdm run playwright install chromium --with-deps || true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Allure CLI
        uses: actions/cache@v4
        with:
          key: allure-2.34.1-${{ runner.os }}
          path: $HOME/.allure

      - name: Install Allure CLI
        run: |
          if [[ ! -f "$HOME/.allure/allure-2.34.1/bin/allure" ]]; then
            mkdir -p $HOME/.allure
            wget -q https://github.com/allure-framework/allure2/releases/download/2.34.1/allure-2.34.1.tgz -O allure.tgz
            tar -xzf allure.tgz -C $HOME/.allure
            rm allure.tgz
          fi
          echo "$HOME/.allure/allure-2.34.1/bin" >> $GITHUB_PATH

      - name: Verify setup
        run: |
          echo "✅ SUT dependencies installed"
          echo "✅ Test dependencies installed"
          echo "✅ Playwright browsers cached"
          echo "✅ Allure CLI cached"
          echo "Setup completed successfully"

  test-api:  # API tests job
    name: API Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout tests
        uses: actions/checkout@v4

      - name: Checkout SUT
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/LumaireJ
          path: app

      - name: Restore SUT PDM cache
        uses: actions/cache@v4
        with:
          key: pdm-app-${{ runner.os }}-${{ hashFiles('app/pdm.lock') }}
          restore-keys: pdm-app-
          path: |
            ~/.cache/pdm
            app/.venv

      - name: Setup PDM for SUT
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install SUT deps
        working-directory: app
        run: pdm install

      - name: Start SUT
        working-directory: app
        run: |
          nohup pdm run dev > ../app_uvicorn.log 2>&1 &
          echo $! > ../sut.pid
          sleep 3

      - name: Wait for HTTP server
        run: |
          MAX_ATTEMPTS=45
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl --silent --fail --max-time 2 http://localhost:8000/health 2>/dev/null || \
               curl --silent --fail --max-time 2 http://localhost:8000 2>/dev/null; then
              echo "✅ Server is ready!"
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Waiting for server... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          echo "❌ Server failed to start within timeout"
          if [[ -f app_uvicorn.log ]]; then
            echo "=== SUT logs ==="
            tail -50 app_uvicorn.log
          fi
          exit 1

      - name: Restore test PDM cache
        uses: actions/cache@v4
        with:
          key: pdm-test-${{ runner.os }}-${{ hashFiles('pdm.lock') }}
          restore-keys: pdm-test-
          path: |
            ~/.cache/pdm
            .venv

      - name: Setup PDM for tests
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install test deps
        run: pdm install -G dev

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Allure CLI cache
        uses: actions/cache@v4
        with:
          key: allure-2.34.1-${{ runner.os }}
          path: $HOME/.allure

      - name: Setup Allure CLI
        run: echo "$HOME/.allure/allure-2.34.1/bin" >> $GITHUB_PATH

      - name: Run API tests
        working-directory: tests
        run: pdm run pytest -m api -v --alluredir=allure-results-api

      - name: Generate Allure Report
        if: always()
        working-directory: tests
        run: |
          if [[ -d allure-results-api && -n "$(ls -A allure-results-api)" ]]; then
            allure generate allure-results-api --clean -o allure-report-api || true
          fi

      - name: Upload Allure artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-api
          path: tests/allure-report-api
          if-no-files-found: ignore

      - name: Upload SUT logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs-api
          path: app_uvicorn.log
          if-no-files-found: ignore

      - name: Stop SUT
        if: always()
        run: |
          if [[ -f sut.pid ]]; then
            PID=$(cat sut.pid)
            if ps -p $PID > /dev/null 2>&1; then
              kill -TERM $PID 2>/dev/null || true
              sleep 2
              kill -KILL $PID 2>/dev/null || true
            fi
            rm -f sut.pid
          fi

  test-e2e:  # E2E tests job
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: test-api
    timeout-minutes: 20
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout tests
        uses: actions/checkout@v4

      - name: Checkout SUT
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/LumaireJ
          path: app

      - name: Restore SUT PDM cache
        uses: actions/cache@v4
        with:
          key: pdm-app-${{ runner.os }}-${{ hashFiles('app/pdm.lock') }}
          restore-keys: pdm-app-
          path: |
            ~/.cache/pdm
            app/.venv

      - name: Setup PDM for SUT
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install SUT deps
        working-directory: app
        run: pdm install

      - name: Start SUT
        working-directory: app
        run: |
          nohup pdm run dev > ../app_uvicorn.log 2>&1 &
          echo $! > ../sut.pid
          sleep 3

      - name: Wait for HTTP server
        run: |
          MAX_ATTEMPTS=45
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl --silent --fail --max-time 2 http://localhost:8000/health 2>/dev/null || \
               curl --silent --fail --max-time 2 http://localhost:8000 2>/dev/null; then
              echo "✅ Server is ready!"
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Waiting for server... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          echo "❌ Server failed to start within timeout"
          if [[ -f app_uvicorn.log ]]; then
            echo "=== SUT logs ==="
            tail -50 app_uvicorn.log
          fi
          exit 1

      - name: Restore test PDM cache
        uses: actions/cache@v4
        with:
          key: pdm-test-${{ runner.os }}-${{ hashFiles('pdm.lock') }}
          restore-keys: pdm-test-
          path: |
            ~/.cache/pdm
            .venv

      - name: Setup PDM for tests
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: '3.14'

      - name: Install test deps
        run: pdm install -G dev

      - name: Restore Playwright browsers cache
        uses: actions/cache@v4
        with:
          key: playwright-${{ runner.os }}-${{ hashFiles('pdm.lock') }}
          restore-keys: playwright-${{ runner.os }}-
          path: |
            ~/.cache/ms-playwright

      - name: Install Playwright browsers
        working-directory: tests
        run: pdm run playwright install chromium --with-deps || true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Allure CLI cache
        uses: actions/cache@v4
        with:
          key: allure-2.34.1-${{ runner.os }}
          path: $HOME/.allure

      - name: Setup Allure CLI
        run: echo "$HOME/.allure/allure-2.34.1/bin" >> $GITHUB_PATH

      - name: Run E2E tests
        working-directory: tests
        run: pdm run pytest -m e2e -v --alluredir=allure-results-e2e

      - name: Generate Allure Report
        if: always()
        working-directory: tests
        run: |
          if [[ -d allure-results-e2e && -n "$(ls -A allure-results-e2e)" ]]; then
            allure generate allure-results-e2e --clean -o allure-report-e2e || true
          fi

      - name: Upload Allure artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-e2e
          path: tests/allure-report-e2e
          if-no-files-found: ignore

      - name: Upload SUT logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs-e2e
          path: app_uvicorn.log
          if-no-files-found: ignore

      - name: Stop SUT
        if: always()
        run: |
          if [[ -f sut.pid ]]; then
            PID=$(cat sut.pid)
            if ps -p $PID > /dev/null 2>&1; then
              kill -TERM $PID 2>/dev/null || true
              sleep 2
              kill -KILL $PID 2>/dev/null || true
            fi
            rm -f sut.pid
          fi

  report-status:  # Report status back to main repo
    name: Report status back to main repo
    runs-on: ubuntu-latest
    needs: [test-api, test-e2e]
    if: ${{ github.event_name == 'repository_dispatch' && always() }}
    env:
      API_RESULT: ${{ needs.test-api.result }}
      E2E_RESULT: ${{ needs.test-e2e.result }}
      HEAD_SHA: ${{ github.event.client_payload.sha }}
    steps:
      - name: Post commit status back to LumaireJ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_FOR_MAIN_REPO }}
          script: |
            const apiResult = (process.env.API_RESULT || '').toLowerCase();
            const e2eResult = (process.env.E2E_RESULT || '').toLowerCase();

            // Determine overall status
            const allSuccess = apiResult === 'success' && e2eResult === 'success';
            const anyCancelled = apiResult === 'cancelled' || e2eResult === 'cancelled';
            const anyFailure = apiResult === 'failure' || e2eResult === 'failure';

            const state = allSuccess ? 'success'
                        : anyCancelled ? 'failure'  // Treat cancelled as failure to unblock
                        : 'failure';

            let description = '';
            if (allSuccess) {
              description = 'All API/E2E tests passed ✅';
            } else if (anyCancelled) {
              description = 'Tests workflow was cancelled ⚠️';
            } else {
              const failed = [];
              if (apiResult !== 'success') failed.push('API');
              if (e2eResult !== 'success') failed.push('E2E');
              description = `Failed: ${failed.join(', ')} tests ❌`;
            }

            await github.rest.repos.createCommitStatus({
              owner: 'darliaro',
              repo: 'LumaireJ',
              sha: process.env.HEAD_SHA,
              state,
              context: 'API & E2E Tests',
              description
            });
